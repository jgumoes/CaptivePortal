<!DOCTYPE html>
<html>
  <head>
    
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>WiFi Config</title>
    <link rel="stylesheet" href="config.css">
  </head>
<body style='max-width: 580px;'>

<h1 class='h'>WiFi Config</h1>
<br>
<p class='p'>
  <div style='text-align:center;'><span id=device_name_change /></div>
    You are <span id=connection_status></span></p>

  <form id="wifiSaveForm" class='show'>
    <span style="display: none;" class="wrong errSpan" id="saveNetworkWarning" onclick="showDelNetPopup(true); showDeletePopupButton(false);"> 
      Network Not Saved:
      Please forget a network to save the current one
    </span>
  	<h3 class='h'>Available Networks:</h3>
    <h4 class='h'>(refresh if any are missing)</h4>
    <br><br>

    <div id="network_list" class="saveNetworkList">
      <div style="text-align: center;">Scanning for networks...</div>
    </div>
        
    <br>
    <div class='password'>
        <h3 class='h pwd' for='pwd'>Enter Password:</h3>
          <span id=errSpan class=wrong></span>
        <input type='text' id='pwd' name='pwd'><br><br>
        <div>
          <div style='display:inline-block;'>
            <input type="checkbox" id='checkbox' checked=true onclick="show_password()">
          </div>
          <div style='display:inline-block;' id='checkboxLabel' onclick="show_password()">
            Hide Password?
          </div>
        </div>
    </div>
    <br>
    
    <input id='connectButton' type='button' onclick="postWifiSaveForm()" class='connect' value='Connect'>
    
  </form>

<form id="changeNameForm" action='/change_name' method='POST'>
  <hr/>
  <p class='h3'>Change device name from <b><span id=device_name /></b>?</p>
  <div class='p'>
    <div class='namechange_label_container'>
      <span class='namechange_label enter_name'>Enter new device name below</span>
      <span class='namechange_label'>&nbsp(100 characters maximum):</span>
    </div>
  </div>
  <input type='text' id='dev_name' name='dev_name' maxlength='100' placeholder='Enter new device name'>
  <br>
  <input type='submit' class='SubName' value='Save New Name'>
</form>
<br><br>

<div id="deleteNetworksPopup" class="modal">
  <!-- Modal content -->
  <div class="closePopupContainer">
    <div class="closePopup" onclick="showDelNetPopup(false); showDeletePopupButton(true);">&times;</div>
  </div>
  <form id="wifiForgetForm">
    <p>The storage is too full to save any more networks!</p>
    <p>Select which networks to forget:</p>
    <div id="deleteNetworkList"></div>
    <span id=errSpan class=wrong></span>
    <input id="deleteButton" type="button" class="delete" value="Forget Networks" onclick="postWifiForgetForm()">
  </form>
</div>

<script> // deal with the deleteNetworksPopup here
function showDelNetPopup(show){
  document.getElementById("deleteNetworksPopup").style.display = show ? "block" : "none";
  fillErrorMessage('none', '#wifiForgetForm');
}

function showDeletePopupButton(show){
  document.querySelector(".wrong#saveNetworkWarning").style.display = show? "block" : "none";
}

function deleteNetworksPopup(data){
    showDelNetPopup(true);
    const chosenSSID = networkBeingAttempted();
    const delListDiv = document.getElementById("deleteNetworkList");
    var networkList = data["storedNetworks"].filter((n) => {
      console.log(n)
      if(n !== chosenSSID){ return n }
    });
    networkListConstructor(networkList, delListDiv, "checkbox", "delNetList");
  }

  function postWifiForgetForm(){
    fillErrorMessage('none', '#wifiForgetForm');
    const formData = new FormData();
    let forgetNetworkList = [];
    // todo note: this query selector should be the basis of a generic form-filling function
    document.querySelectorAll("#wifiForgetForm .ssidButton input:checked").forEach((x) => {forgetNetworkList.push(x.value)});
    if (forgetNetworkList.length === 0){
      fillErrorMessage('noNetworksSelected', '#wifiForgetForm');
      return false;
    }
    formData.append('forget', forgetNetworkList);
    showDelNetPopup(false);
    waitingForFormResponse(true, 'wifiSaveForm');
    postForm(formData, 3, route = '/wififorget', errorID="#saveNetworkWarning");
  }

  let DeleteNetworksPopup = class {
    // TODO: replace all popup function calls with those in this class
    constructor () {
      this.networkList; // TODO: do I actually need to store the state as a class variable if it's already stored in HTML?
    }
    set setNetworkList(list){
      // TODO: this needs to be called everywhere maybe i dunno
      this.networkList = list;
    }

    showErrorButton(show){
      // TODO: replaces showDeletePopupButton
      document.querySelector(".wrong#saveNetworkWarning").style.display = show? "block" : "none";
    }

    showPopup(show=true, data=none, showErrorButton=false) {
      // TODO: replaces showDelNetPopup, deleteNetworksPopup
      // Opens and closes the popup. If data isn't given, it's
      // presumed that fillPopup has already been called elsewhere
      if (data !== none){fillPopup(data)}
      document.getElementById("deleteNetworksPopup").style.display = show ? "block" : "none";
      fillErrorMessage('none', '#wifiForgetForm');
      showErrorButton(!show && showErrorButton); // hide button if show is true, otherwise set to showErrorButton
    }

    fillPopup(data){
      const chosenSSID = networkBeingAttempted();
      const delListDiv = document.getElementById("deleteNetworkList");
      var networkList = data["storedNetworks"].filter((n) => {
        console.log(n)
        if(n !== chosenSSID){ return n }
      });
      networkListConstructor(networkList, delListDiv, "checkbox", "delNetList");
    }
  }
  
</script>

<script> // form POSTs will get handled here

  document.getElementById('pwd').addEventListener('keypress', (e) => handleFormEnter(e, 'pwd'))

  function handleFormEnter(event, elementID){
    const keyCode = event.code;
    const postForms = {'pwd': postWifiSaveForm} // which form-sending-function to call for which elementID
    if(keyCode === "Enter"){
      event.preventDefault();
      postForms[elementID]();
      return false;
    }
    return true;
  }
  
  function waitingForFormResponse(waiting, formID){
    // this should work for wifiSaveForm, saveDeviceName, and any other forms that may be added along the way
    const form = document.getElementById(formID)
    if (waiting){ fillErrorMessage("none") }
    hideOrShowForm(form, waiting)
    for (el of form.elements){ el.disabled = waiting }
  }

  function networkBeingAttempted(){
    // it might be a good idea to put the post stuff into a class,
    // so that this function isn't needed
    return document.getElementById('wifiSaveForm').elements.ssid.value
  }
  
  function postWifiSaveForm(){
    // this COULD be refactored into a generic postForm function, but should it?
    // A: sort of.
    const formData = new FormData();
    const wifiForm = document.getElementById('wifiSaveForm')
    const chosenSSID = networkBeingAttempted();
    if(chosenSSID === ""){
      fillErrorMessage("noNetworkSelected")
      return false;
    }
    formData.append('ssid', chosenSSID)
    formData.append('pwd', wifiForm.elements.pwd.value)
    console.log('formData', formData);
    waitingForFormResponse(true, 'wifiSaveForm')
    postForm(formData);
  }

  function postForm(formData, reattempt = 3, route = '/wifisave', errorID="#wifiSaveForm"){
    // reattempt signals whether this function should be called again
    // if the fetch attempt fails
    fetch(route, {method: 'POST', body: formData})
      .then(result => result.json())
      .then(data => {
        fillErrorMessage(data.error, errorID);
        const dataTrue = ["none", "storageFull"]; // a check to make sure a bad attempt isn't filled as being successfull
        fillConnectionStatus({'networkName': dataTrue.includes(data.error) && networkBeingAttempted()}); // keep this statement as is, incase some dickhead calls their network "none"
        waitingForFormResponse(false, 'wifiSaveForm');
        if(data.error === "storageFull"){ deleteNetworksPopup(data);} //TODO update with correct function call
      })
      .catch(error => {
        if(reattempt > 1){postForm(formData, reattempt - 1, route)}
        else{
          waitingForFormResponse(false, 'wifiSaveForm');
          fillErrorMessage("other", errorID);
          console.log(error);
        }
      })
  }
</script>
<script> // html elements are filled and adjusted here
  function hideOrShowForm(form, hide){
    if(hide){ form.setAttribute('class', 'hide') }
    else { form.setAttribute('class', 'show') }
  }

  async function getServerInfo(){
    fetch('/server_info', {method: 'GET'})
    .then(result => result.json())
    .then(data => fillFlaggedElements(data))
  }

  function fillNameChange(flags){
    // this has been removed from server flags, but will need to be re-implemented somewhere
    const {deviceName, nameChange} = flags;
    var nameChangeSpan = document.getElementById('device_name_change');
    if (nameChange === true){
      nameChangeSpan.insertAdjacentHTML("afterbegin", `<b class='NameChange'>Device name changed to <em>${deviceName}</em></b><br>`)
    }
  }

  function fillDeviceName(flags){
    const {deviceName} = flags;
    var deviceNameSpan = document.getElementById('device_name');
    deviceNameSpan.innerText = deviceName;
  }

  function fillConnectionStatus(flags){
    const {networkName, networkSaved} = flags;
    console.log('fillConnectionStatus', networkName);
    var connectionStatusSpan = document.getElementById('connection_status')
    if (!networkName){
      connectionStatusSpan.innerText = "not connected to a network"
    }
    else{
      connectionStatusSpan.innerText = `connected to ${networkName}`
      if(!networkSaved){showDeletePopupButton(true)} // TODO: update with correct call
    }
  }

  function fillErrorMessage(result, formID = "#wifiSaveForm"){
    // The function formally known as fillWrongPassword. Fills the error message
    // maybe convert this into a pop-up? https://www.w3schools.com/howto/howto_js_popup.asp
    var errorMessageSpan = document.querySelector(`${formID} #errSpan`);

    const htmlOptions = {
      "none": "",
      'wrongPass': "Wrong Password",
      'networkLost': "Lost the Network",
      'other': "Server Error",
      'noNetworkSelected': "Please Select a Network Above",
      'noNetworksSelected': "Please Select one or more Networks Above",
      "storageFull": "Network not Saved: Device Storage is Full"
    }
    errorMessageSpan.innerText = htmlOptions[result]
  }

  function fillFlaggedElements(flags){
    console.log(flags);
    fillDeviceName(flags)
    // fillNameChange(flags)
    fillConnectionStatus(flags)
  }

  getServerInfo();
</script>
<script> // the network list is fetched and filled here
  async function getNetworkList(){
    fetch('/scan_networks', {method: 'GET'})
    .then(result => result.json())
    .then(data => fillNetworkList(data))
  }

  function fillNetworkList(data){
    console.log('ssids: ' + data);
    var networkDiv = document.getElementById('network_list')
    var ssids = data.network_list
    var disabled = false;
    if(ssids.length === 0){
      ssids = ["No Networks Found"]
      disabled = true;
      disableConnectButton();
    }

    networkListConstructor(ssids, networkDiv, 'radio', 'saveNetList');

    if(disabled){document.getElementsByName("ssid")[0].disabled = true;}
    // todo: check last attempted network (if needed for refreshing the networks)

    var attempted_network = data.attempted_network
    document.getElementById(attempted_network).checked = true
  }

  function setLabelCheck(element){
    if(element.type === "radio"){
      for (el of document.querySelectorAll("input[type=radio]")){
        el.parentElement.id = "not_chosen";
      }
    }
    const parent = element.parentElement;
    console.log('setLabelCheck:', parent);
    parent.id = element.checked ? "chosen" : "not_chosen";
  }

  function networkListConstructor(ssids, targetDiv, type, className){
    targetDiv.innerHTML = "";
    check = type == "radio" ? "" : "X";
    for (ssid of ssids){
      const cam_name = `${ssid.replaceAll(/\W/ig, "")}_${className}`;
      html = `<div class="ssidButton ${className}"">` + 
        `<input id="${cam_name}" type=${type} name='ssid' value=\"${ssid}\" required>` +
        `<label for="${cam_name}">` +
        `<div class='checkmark'><div class='checked'>${check}</div></div>` +
        `${ssid}</label>` + 
        `</div>`
     targetDiv.insertAdjacentHTML("afterbegin", html);
    }
  }

  function disableConnectButton(){
    var connectButton = document.getElementById('connectButton')
    connectButton.disabled = true;
    // connectButton.input = 'button'
    connectButton.style.background = '#bdbdbd';
    // connectButton.onclick = () => {window.confirm("There aren't any networks to connect to!")}
  }

  getNetworkList();

  function show_password() {
    const checkbox = document.getElementById("checkbox")
    const checkboxTypes = { true: "text", false: "password"}
    const checkboxLabels = { true: "Hide Password?", false: "Show Password?"}
    checkbox.checked = !checkbox.checked;
    document.getElementById("pwd").type = checkboxTypes[checkbox.checked]
    document.getElementById('checkboxLabel').innerText = checkboxLabels[checkbox.checked]
  }
</script>
</body>
</html>